name: CI-CD Dev-Lane
# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch.

# Repository Secrets needed to execute this workflow
# ==================================================
# GH_TOKEN : https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token
# MAIL_FROM_NAME : A mailer name (Generally proposed as project developer)
# MAIL_USERNAME : A mailer email username to send email from
# MAIL_PASSWORD : Email password to send email from (For Google mail servers, we need app-specific password : https://myaccount.google.com/apppasswords)
# MAIL_TO : Recipients of the generated build release
# ==================================================
# Optional
# ==================================================
# KEYSTORE_JKS_BASE64 : A base64 String of .JKS keystore file. Can be generated by : openssl base64 -A -in android/key.jks
# KEY_PROPERTIES_BASE64 : A base64 String of key.properties file. Can be generated by : openssl base64 -A -in android/key.properties

on:
  push:
    branches:
      - dev
jobs:
  build:
    name: Build Artifacts and Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - name: Setup Java
        uses: actions/setup-java@v1
        with:
          java-version: "8.x"
      - name: Setup Flutter
        uses: subosito/flutter-action@v1
        with:
          flutter-version: "2.10.4"
          channel: 'stable'
      - name: Pub Get Packages
        run: flutter pub get

      - name: Build APPBUNDLE & APK
        run: flutter build appbundle --release && flutter build apk --release

      - name: Upload to gdrive
        uses: Jodebu/upload-to-drive@master
        id: driveUpload
        with:
          credentials: ${{ secrets.GSA_CREDENTIALS }}
          target: "build/app/outputs/flutter-apk/app-release.apk"
          folder: ${{ secrets.DRIVE_FOLDER_ID }}
          name: "$(date)-build-app-release.apk"

      - name: Slack Notification
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_CHANNEL: diet-app
          SLACK_COLOR: ${{ job.status }} # or a specific color like 'good' or '#ff00ff'
          SLACK_MESSAGE: "APK uploaded to ${{ steps.driveUpload.outputs.link }}"
          SLACK_TITLE: Dev Release Deployed
          SLACK_USERNAME: ishaquehassan
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_ICON: https://pocketsystems.net/assets/frontend/img/logo.png